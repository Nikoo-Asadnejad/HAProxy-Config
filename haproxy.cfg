# Global settings
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Max connections
    maxconn 4096
    pidfile /var/run/haproxy.pid

# Default settings for all proxies
defaults
    log global
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Frontend for HTTP and HTTPS
frontend http_front
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/haproxy.pem  # SSL Termination
    mode http
    acl is_http hdr(Host) -i example.com
    acl is_https ssl_fc
    redirect scheme https if !is_https

    # Define access control list (ACL) rules for routing
    acl is_api path_beg /api
    acl is_static path_beg /static

    # Default backend for non-API traffic
    use_backend api_backend if is_api
    use_backend static_backend if is_static
    default_backend web_backend

# Backend for serving static content
backend static_backend
    balance roundrobin
    server static1 192.168.1.101:80 check
    server static2 192.168.1.102:80 check

# Backend for API requests (with session persistence)
backend api_backend
    balance roundrobin
    cookie JSESSIONID prefix
    server api1 192.168.1.103:8080 check
    server api2 192.168.1.104:8080 check

# Main backend for general web traffic
backend web_backend
    balance roundrobin
    option httpchk
    server web1 192.168.1.105:80 check
    server web2 192.168.1.106:80 check

# Stats page configuration (for monitoring)
frontend stats_front
    bind *:9000
    mode http
    stats enable
    stats uri /stats
    stats auth admin:password  # Username:Password for stats page
    stats refresh 10s

# Health Check for backend servers
backend web_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    server web1 192.168.1.105:80 check
    server web2 192.168.1.106:80 check

# Logging settings for better visibility
frontend http_front
    log global
    option httplog
    option logasap
    log-format "%ci:%cp [%t] %ft %b/%s %TR %Tw %Tc %Tt %ts %ac %fc %bc %sc %sq %bq %hr %hs"
